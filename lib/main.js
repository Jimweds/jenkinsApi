"use strict";const util=require("util"),qs=require("querystring"),request=require("request"),fs=require("fs"),API="/api/json",LIST=API,CREATE="/createItem"+API,BUILD_START="/job/%s/build"+API,BUILD_START_WITHPARAMS="/job/%s/buildWithParameters",BUILD_STOP="/job/%s/%s/stop",BUILD_INFO="/job/%s/%s"+API,BUILD_DELETE="/job/%s/%s/doDelete",ALL_BUILDS=`/job/%s${API}?tree=allBuilds[%s]`,LAST_SUCCESS="/job/%s/lastSuccessfulBuild"+API,TEST_REPORT="/job/%s/%s/testReport"+API,LAST_BUILD="/job/%s/lastBuild"+API,LAST_COMPLETED_BUILD="/job/%s/lastCompletedBuild"+API,COMPUTERS="/computer"+API,VIEW_LIST=LIST,VIEW_INFO="/view/%s"+API,VIEW_CREATE="/createView"+API,VIEW_CONFIG="/view/%s/configSubmit",VIEW_DELETE="/view/%s/doDelete"+API,VIEW_ADD_JOB="/view/%s/addJobToView"+API,VIEW_REMOVE_JOB="/view/%s/removeJobFromView"+API,JOB_LIST=LIST,JOB_CREATE=CREATE,JOB_INFO="/job/%s"+API,JOB_CONFIG="/job/%s/config.xml"+API,JOB_OUTPUT="/job/%s/%s/consoleText"+API,JOB_DELETE="/job/%s/doDelete"+API,JOB_DISABLE="/job/%s/disable",JOB_ENABLE="/job/%s/enable",QUEUE="/queue"+API,QUEUE_ITEM="/queue/item/%s"+API,QUEUE_CANCEL_ITEM="/queue/cancelItem"+API,PLUGINS="/pluginManager"+API,INSTALL_PLUGIN="/pluginManager/installNecessaryPlugins"+API,NEWFOLDER=CREATE,HTTP_CODE_200=200,HTTP_CODE_201=201,HTTP_CODE_204=204,HTTP_CODE_302=302;function getType(t){return Array.isArray(t)?"array":null===t?"null":typeof t}function doArgs(t,n){let o,e,r,s,i;var u=[];for(e of n)if(r||(o=Array.prototype.shift.call(t)),Array.isArray(e)?(s=!0,i=e[1],e=e[0]):s=!1,(e=e.split("|")).includes(getType(o)))u.push(o),r=!1;else{if(!s)throw Error("Invalid arguments");u.push(i),r=!0}return t.length,u}function tryParseJson(n,o,e){[n,o,e]=doArgs(arguments,["string","string|array|function|null","function"]);try{n=n.replace(/\x1b/g,"");let t=JSON.parse(n.toString());if(o){var r=getType(o);if("array"===r){var s={};for(const i of o)s[i]=t[i];t=s}"string"===r&&(t=t[o]),"function"===r&&(t=o(t))}e(null,t)}catch(t){e(t,n)}}exports.init=function(o,s,e){let o="";o="online"!=global.env||isTest?"https://tiangang:111044f6d1365d50b37c13a8a1d369598c@jenkins.firstshare.cn":"https://tiangang:1195c7886d2949f573b8d588843876eea5@oss.foneshare.cn/jenkins";const r=function(t,n){var o,n=Object.assign({},e,n),n=qs.stringify(n);return""===n?t:(o=t.includes("?")?"&":"?",t+o+n)};function i(t,n){t=function(){return o+util.format.apply(null,arguments)}.apply(null,t);return r(t,n)}function u(t,n,e){const r=Object.assign({},{urlPattern:["/"],method:"GET",successStatusCodes:[HTTP_CODE_200],failureStatusCodes:[],bodyProp:null,noparse:!1,request:{}},s,t);t=i(r.urlPattern,n),n=Object.assign({method:r.method,url:t,headers:[],followAllRedirects:!0,form:null,body:null},r.request),request(n,function(t,n,o){t?e(t,n):Array.isArray(r.successStatusCodes)&&!r.successStatusCodes.includes(n.statusCode)||Array.isArray(r.failureStatusCodes)&&r.failureStatusCodes.includes(n.statusCode)?e("Server returned unexpected status code: "+n.statusCode,n):r.noparse?("string"==typeof o&&(o={body:o}),(t=n.headers.Location||n.headers.location)&&(o.location=t),o.statusCode=n.statusCode,e(null,o)):tryParseJson(o,r.bodyProp,e)})}return{build:function(t,n,o){[t,n,o]=doArgs(arguments,["string",["object",{}],"function"]),u({method:"POST",urlPattern:[BUILD_START,t],successStatusCodes:[HTTP_CODE_201,HTTP_CODE_302],noparse:!0},n,function(t,n){t?o(t,n):(t=+/\/queue\/item\/(\d+)/.exec(n.location)[1],n.queueId=t,o(null,n))})},build_with_params:function(t,n,o){[t,n,o]=doArgs(arguments,["string",["object",{}],"function"]),u({method:"POST",urlPattern:[BUILD_START_WITHPARAMS,t],successStatusCodes:[HTTP_CODE_201,HTTP_CODE_302],noparse:!0},n,function(t,n){t?o(t,n):(t=+/\/queue\/item\/(\d+)/.exec(n.location)[1],n.queueId=t,o(null,n))})},stop_build:function(t,o,n,e){[t,o,n,e]=doArgs(arguments,["string","string|number",["object",{}],"function"]),u({method:"POST",urlPattern:[BUILD_STOP,t,o],noparse:!0},n,function(t,n){t?e(t,n):(n.body=`Build ${o} stopped.`,e(null,n))})},console_output:function(t,n,o,e){[t,n,o,e]=doArgs(arguments,["string","string|number",["object",{}],"function"]),u({urlPattern:[JOB_OUTPUT,t,n],noparse:!0},o,e)},last_build_info:function(t,n,o){[t,n,o]=doArgs(arguments,["string",["object",{}],"function"]),u({urlPattern:[LAST_BUILD,t]},n,o)},last_completed_build_info:function(t,n,o){[t,n,o]=doArgs(arguments,["string",["object",{}],"function"]),u({urlPattern:[LAST_COMPLETED_BUILD,t]},n,o)},build_info:function(t,n,o,e){[t,n,o,e]=doArgs(arguments,["string","string|number",["object",{}],"function"]),u({urlPattern:[BUILD_INFO,t,n]},o,e)},all_builds:function(t,n,o,e){[t,n,o,e]=doArgs(arguments,["string",["string","id,timestamp,result,duration"],["object",{}],"function"]),u({urlPattern:[ALL_BUILDS,t,n],bodyProp:"allBuilds"},o,e)},test_result:function(t,n,o,e){[t,n,o,e]=doArgs(arguments,["string","string|number",["object",{}],"function"]),u({urlPattern:[TEST_REPORT,t,n]},o,e)},last_build_report:function(t,n,o){this.last_build_info(t,n,o)},delete_build:function(t,o,n,e){[t,o,n,e]=doArgs(arguments,["string","string|number",["object",{}],"function"]),u({method:"POST",urlPattern:[BUILD_DELETE,t,o],noparse:!0},n,function(t,n){t?e(t,n):(n.body=`Build ${o} deleted.`,e(null,n))})},all_jobs:function(t,n){[t,n]=doArgs(arguments,[["object",{}],"function"]),u({urlPattern:[JOB_LIST],bodyProp:"jobs"},t,n)},get_config_xml:function(t,n,o){[t,n,o]=doArgs(arguments,["string",["object",{}],"function"]),u({urlPattern:[JOB_CONFIG,t],noparse:!0},n,function(t,n){t?o(t,n):o(null,n.body)})},update_config:function(o,e,r,s){[o,e,r,s]=doArgs(arguments,["string","function",["object",{}],"function"]);const i=this;i.get_config_xml(o,r,function(t,n){t?s(t,n):(n=e(n),i.update_job(o,n,r,s))})},update_job:function(o,t,n,e){[o,t,n,e]=doArgs(arguments,["string","string",["object",{}],"function"]),u({method:"POST",urlPattern:[JOB_CONFIG,o],request:{body:t,headers:{"Content-Type":"application/xml"}},noparse:!0},n,function(t,n){t?e(t,n):e(null,{name:o})})},job_info:function(t,n,o){[t,n,o]=doArgs(arguments,["string",["object",{}],"function"]),u({urlPattern:[JOB_INFO,t]},n,o)},create_job:function(o,t,e,r){[o,t,e,r]=doArgs(arguments,["string","string",["object",{}],"function"]),e.name=o;const s=this;u({method:"POST",urlPattern:[JOB_CREATE],request:{body:t,headers:{"Content-Type":"application/xml"}},noparse:!0},e,function(t,n){t?r(t,n):s.job_info(o,e,r)})},copy_job:function(t,o,e,r,s){[t,o,e,r,s]=doArgs(arguments,["string","string","function",["object",{}],"function"]);const i=this;this.get_config_xml(t,r,function(t,n){t?s(t,n):(n=e(n),i.create_job(o,n,r,s))})},delete_job:function(o,t,e){[o,t,e]=doArgs(arguments,["string",["object",{}],"function"]),u({method:"POST",urlPattern:[JOB_DELETE,o],noparse:!0},t,function(t,n){t?e(t,n):e(null,{name:o})})},disable_job:function(o,e,r){[o,e,r]=doArgs(arguments,["string",["object",{}],"function"]);const s=this;u({method:"POST",urlPattern:[JOB_DISABLE,o],noparse:!0},e,function(t,n){t?r(t,n):s.job_info(o,e,r)})},enable_job:function(o,e,r){[o,e,r]=doArgs(arguments,["string",["object",{}],"function"]);const s=this;u({method:"POST",urlPattern:[JOB_ENABLE,o],noparse:!0},e,function(t,n){t?r(t,n):s.job_info(o,e,r)})},last_success:function(t,n,o){[t,n,o]=doArgs(arguments,["string",["object",{}],"function"]),u({method:"POST",urlPattern:[LAST_SUCCESS,t]},n,o)},last_result:function(o,e,r){[o,e,r]=doArgs(arguments,["string",["object",{}],"function"]),this.job_info(o,function(t,n){t?r(t,n):(t=n.lastBuild.url,u({urlPattern:[t+API,o]},e,r))})},queue:function(t,n){[t,n]=doArgs(arguments,[["object",{}],"function"]),u({urlPattern:[QUEUE]},t,n)},queue_item:function(t,n,o){[t,n,o]=doArgs(arguments,["string|number",["object",{}],"function"]),u({urlPattern:[QUEUE_ITEM,t]},n,o)},cancel_item:function(t,n,o){[t,n,o]=doArgs(arguments,["string|number",["object",{}],"function"]),n.id=t,u({method:"POST",urlPattern:[QUEUE_CANCEL_ITEM],successStatusCodes:[HTTP_CODE_201,HTTP_CODE_204,HTTP_CODE_302],noparse:!0},n,o)},computers:function(t,n){[t,n]=doArgs(arguments,[["object",{}],"function"]),u({urlPattern:[COMPUTERS]},t,n)},all_views:function(t,n){[t,n]=doArgs(arguments,[["object",{}],"function"]),u({urlPattern:[VIEW_LIST],bodyProp:"views"},t,n)},create_view:function(o,t,e,r){[o,t,e,r]=doArgs(arguments,["string",["string","hudson.model.ListView"],["object",{}],"function"]);t={name:o,mode:t};t.json=JSON.stringify(t);const s=this;u({method:"POST",urlPattern:[VIEW_CREATE],request:{form:t},noparse:!0},e,function(t,n){t?r(t,n):s.view_info(o,e,r)})},view_info:function(t,n,o){[t,n,o]=doArgs(arguments,["string",["object",{}],"function"]),u({urlPattern:[VIEW_INFO,t]},n,o)},update_view:function(o,t,e,r){[o,t,e,r]=doArgs(arguments,["string","object",["object",{}],"function"]),t.json=JSON.stringify(t);const s=this;u({method:"POST",urlPattern:[VIEW_CONFIG,o],request:{form:t},noparse:!0},e,function(t,n){t?r(t,n):s.view_info(o,e,r)})},delete_view:function(o,t,e){[o,t,e]=doArgs(arguments,["string",["object",{}],"function"]),u({method:"POST",urlPattern:[VIEW_DELETE,o],noparse:!0},t,function(t,n){t?e(t,n):e(null,{name:o})})},add_job_to_view:function(t,n,o,e){[t,n,o,e]=doArgs(arguments,["string","string",["object",{}],"function"]),o.name=n,u({method:"POST",urlPattern:[VIEW_ADD_JOB,t],noparse:!0},o,e)},remove_job_from_view:function(t,n,o,e){[t,n,o,e]=doArgs(arguments,["string","string",["object",{}],"function"]),o.name=n,u({method:"POST",urlPattern:[VIEW_REMOVE_JOB,t],noparse:!0},o,e)},all_jobs_in_view:function(t,n,o){[t,n,o]=doArgs(arguments,["string",["object",{}],"function"]),u({urlPattern:[VIEW_INFO,t],bodyProp:"jobs"},n,o)},all_installed_plugins:function(t,n){[t,n]=doArgs(arguments,[["object",{}],"function"]),t.depth=1,u({urlPattern:[PLUGINS],failureStatusCodes:[HTTP_CODE_302],noparse:!0,bodyProp:"plugins"},t,n)},install_plugin:function(t,n,o){[t,n,o]=doArgs(arguments,["string",["object",{}],"function"]);t=`<jenkins><install plugin="${t}" /></jenkins>`;u({method:"POST",urlPattern:[INSTALL_PLUGIN],request:{body:t,headers:{"Content-Type":"text/xml"}},noparse:!0,bodyProp:"plugins"},n,o)},create_folder:function(t,n,o){[t,n,o]=doArgs(arguments,["string",["object",{}],"function"]);n.name=t,n.mode="com.cloudbees.hudson.plugins.folder.Folder",n.Submit="OK",u({method:"POST",urlPattern:[NEWFOLDER]},n,o)}}};
